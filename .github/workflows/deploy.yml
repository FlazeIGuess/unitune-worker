name: Deploy to Cloudflare

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_json:
        description: >
          JSON string produced by scripts/parse-changelog.js in the app repo.
          When provided, overwrites generated-version.js before deploying so
          the worker serves the latest release data immediately.
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # When triggered by the app release workflow, write the parsed version data
    # into generated-version.js so it is bundled into the worker at deploy time.
    - name: Inject version data from app release
      if: ${{ inputs.version_json != '' }}
      run: |
        echo '${{ inputs.version_json }}' | node -e "
          const fs = require('fs');
          let raw = '';
          process.stdin.on('data', d => raw += d);
          process.stdin.on('end', () => {
            const parsed = JSON.parse(raw);
            const js = '// generated-version.js â€” auto-generated by CI\n' +
                       'export default ' + JSON.stringify(parsed, null, 2) + ';\n';
            fs.writeFileSync('generated-version.js', js);
            process.stderr.write('generated-version.js updated to v' + parsed.latest_version + '+' + parsed.latest_build + '\n');
          });
        "

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Deploy to Cloudflare Workers
      run: wrangler deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

